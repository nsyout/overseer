#!/usr/bin/env node
/**
 * Unified CLI entry point
 * 
 * Delegates all commands to the native binary.
 * The native binary handles spawning Node for `ui` and `mcp` commands.
 */
import { existsSync, readFileSync } from "node:fs";
import { execSync, spawn } from "node:child_process";
import { platform, arch } from "node:process";
import { createRequire } from "node:module";
import { fileURLToPath } from "node:url";
import { dirname, join } from "node:path";

const require = createRequire(import.meta.url);
const __dirname = dirname(fileURLToPath(import.meta.url));

const PLATFORMS = {
  "darwin-arm64": "@dmmulroy/overseer-darwin-arm64",
  "darwin-x64": "@dmmulroy/overseer-darwin-x64",
  "linux-arm64": "@dmmulroy/overseer-linux-arm64",
  "linux-x64": "@dmmulroy/overseer-linux-x64",
  "linux-arm64-musl": "@dmmulroy/overseer-linux-arm64-musl",
  "linux-x64-musl": "@dmmulroy/overseer-linux-x64-musl",
};

function isMusl() {
  if (platform !== "linux") return false;
  if (existsSync("/etc/alpine-release")) return true;
  try {
    const maps = readFileSync("/proc/self/maps", "utf8");
    if (maps.includes("musl")) return true;
  } catch {}
  try {
    const output = execSync("ldd --version 2>&1", { encoding: "utf8" });
    return output.toLowerCase().includes("musl");
  } catch (err) {
    const stderr = err.stderr?.toString() || err.message || "";
    return stderr.toLowerCase().includes("musl");
  }
}

function getBinaryPath() {
  if (process.env.OVERSEER_CLI_PATH) {
    return process.env.OVERSEER_CLI_PATH;
  }

  const cpuArch = arch === "arm64" ? "arm64" : "x64";
  const libc = isMusl() ? "-musl" : "";
  const key = `${platform}-${cpuArch}${libc}`;
  const pkg = PLATFORMS[key];

  if (!pkg) {
    console.error(`Unsupported platform: ${key}`);
    console.error("Your platform is not supported. Please open an issue at:");
    console.error("  https://github.com/dmmulroy/overseer/issues");
    process.exit(1);
  }

  try {
    const pkgPath = require.resolve(`${pkg}/package.json`);
    return join(dirname(pkgPath), "os");
  } catch {
    console.error(`Platform package not installed: ${pkg}`);
    console.error(`\nTry one of:`);
    console.error(`  npm install -g ${pkg}`);
    console.error(`  npm install -g @dmmulroy/overseer --include=optional`);
    console.error(`\nIf you have npm configured to omit optional deps, check:`);
    console.error(`  npm config get omit`);
    process.exit(1);
  }
}

const args = process.argv.slice(2);

// All commands delegate to the native binary
// The binary handles `ui` and `mcp` by spawning Node with the host package
const child = spawn(getBinaryPath(), args, {
  stdio: "inherit",
});

child.on("error", (err) => {
  console.error(`Failed to run os: ${err.message}`);
  process.exit(1);
});

child.on("exit", (code, signal) => {
  if (signal) {
    process.kill(process.pid, signal);
  } else {
    process.exit(code ?? 0);
  }
});
