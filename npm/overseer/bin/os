#!/usr/bin/env node
/**
 * Unified CLI entry point
 * - `os mcp` → starts MCP server (Node, codemode)
 * - `os <cmd>` → forwards to native binary
 */
import { existsSync, readFileSync } from "node:fs";
import { execSync, spawn } from "node:child_process";
import { platform, arch } from "node:process";
import { createRequire } from "node:module";
import { fileURLToPath } from "node:url";
import { dirname, join } from "node:path";

const require = createRequire(import.meta.url);
const __dirname = dirname(fileURLToPath(import.meta.url));

const PLATFORMS = {
  "darwin-arm64": "@dmmulroy/overseer-darwin-arm64",
  "darwin-x64": "@dmmulroy/overseer-darwin-x64",
  "linux-arm64": "@dmmulroy/overseer-linux-arm64",
  "linux-x64": "@dmmulroy/overseer-linux-x64",
  "linux-arm64-musl": "@dmmulroy/overseer-linux-arm64-musl",
  "linux-x64-musl": "@dmmulroy/overseer-linux-x64-musl",
};

function isMusl() {
  if (platform !== "linux") return false;
  if (existsSync("/etc/alpine-release")) return true;
  try {
    const maps = readFileSync("/proc/self/maps", "utf8");
    if (maps.includes("musl")) return true;
  } catch {}
  try {
    const output = execSync("ldd --version 2>&1", { encoding: "utf8" });
    return output.toLowerCase().includes("musl");
  } catch (err) {
    const stderr = err.stderr?.toString() || err.message || "";
    return stderr.toLowerCase().includes("musl");
  }
}

function getBinaryPath() {
  if (process.env.OVERSEER_CLI_PATH) {
    return process.env.OVERSEER_CLI_PATH;
  }

  const cpuArch = arch === "arm64" ? "arm64" : "x64";
  const libc = isMusl() ? "-musl" : "";
  const key = `${platform}-${cpuArch}${libc}`;
  const pkg = PLATFORMS[key];

  if (!pkg) {
    console.error(`Unsupported platform: ${key}`);
    console.error("Your platform is not supported. Please open an issue at:");
    console.error("  https://github.com/dmmulroy/overseer/issues");
    process.exit(1);
  }

  try {
    const pkgPath = require.resolve(`${pkg}/package.json`);
    return join(dirname(pkgPath), "os");
  } catch {
    console.error(`Platform package not installed: ${pkg}`);
    console.error(`\nTry one of:`);
    console.error(`  npm install -g ${pkg}`);
    console.error(`  npm install -g @dmmulroy/overseer --include=optional`);
    console.error(`\nIf you have npm configured to omit optional deps, check:`);
    console.error(`  npm config get omit`);
    process.exit(1);
  }
}

const args = process.argv.slice(2);
const command = args[0];

// Handle `os mcp` - start MCP server
if (command === "mcp") {
  const binaryPath = getBinaryPath();
  process.env.OVERSEER_CLI_PATH = binaryPath;

  const serverPath = join(__dirname, "..", "dist", "index.js");
  import(serverPath).catch((err) => {
    console.error("Failed to start MCP server:", err.message);
    process.exit(1);
  });
}
// Handle `os ui` - start Task Viewer webapp
else if (command === "ui") {
  startUiServer(args.slice(1));
}
// All other commands - passthrough to native binary
else {
  const child = spawn(getBinaryPath(), args, {
    stdio: "inherit",
  });

  child.on("error", (err) => {
    console.error(`Failed to run os: ${err.message}`);
    process.exit(1);
  });

  child.on("exit", (code, signal) => {
    if (signal) {
      process.kill(process.pid, signal);
    } else {
      process.exit(code ?? 0);
    }
  });
}

/**
 * Start the UI server
 * Usage: os ui [port] [--port PORT] [--no-open]
 */
function startUiServer(uiArgs) {
  // Parse args: positional port, --port flag, --no-open flag
  let port = null;
  let openBrowser = true;  // Default: open browser

  for (let i = 0; i < uiArgs.length; i++) {
    const arg = uiArgs[i];
    if (arg === "--port" && i + 1 < uiArgs.length) {
      port = parseInt(uiArgs[++i], 10);
    } else if (arg === "--no-open") {
      openBrowser = false;
    } else if (arg === "--help" || arg === "-h") {
      console.log(`Usage: os ui [port] [--port PORT] [--no-open]

Options:
  port          Port number (positional, default: 6969)
  --port PORT   Port number (explicit flag)
  --no-open     Don't open browser automatically

Examples:
  os ui              # Start and open browser
  os ui 8080         # Port 8080, open browser
  os ui --port 3000  # Port 3000, open browser
  os ui --no-open    # Start without opening browser`);
      process.exit(0);
    } else if (/^\d+$/.test(arg) && port === null) {
      // Positional port number
      port = parseInt(arg, 10);
    }
  }

  // Port precedence: --port > positional > PORT env > 6969
  if (port === null && process.env.PORT) {
    port = parseInt(process.env.PORT, 10);
  }
  if (port === null || isNaN(port)) {
    port = 6969;
  }

  // Graceful shutdown handler
  const shutdown = () => {
    process.stdout.write('\x1b[0m');  // Reset terminal attributes
    console.log('\nServer stopped');
    process.exit(0);
  };
  process.on('SIGINT', shutdown);
  process.on('SIGTERM', shutdown);

  // Set up environment for the UI server
  const binaryPath = getBinaryPath();
  process.env.OVERSEER_CLI_PATH = binaryPath;
  process.env.PORT = String(port);
  process.env.NODE_ENV = "production";
  
  // Preserve original cwd for CLI calls (must happen before chdir)
  process.env.OVERSEER_CLI_CWD = process.cwd();
  
  // Static files are in dist/ui/static/ relative to package root
  const uiDir = join(__dirname, "..", "dist", "ui");
  process.env.OVERSEER_UI_STATIC_ROOT = join(uiDir, "static");

  // Change cwd to ui dir (serveStatic needs relative path from cwd)
  process.chdir(uiDir);

  const serverPath = join(uiDir, "server.js");
  
  if (!existsSync(serverPath)) {
    console.error("UI server not found. The package may not have been built correctly.");
    console.error(`Expected: ${serverPath}`);
    process.exit(1);
  }

  // Open browser after server starts (default behavior)
  if (openBrowser) {
    // Delay to let server start
    setTimeout(() => {
      const url = `http://localhost:${port}`;
      const openCmd =
        platform === "darwin" ? "open" :
        platform === "win32" ? "start" : "xdg-open";
      try {
        execSync(`${openCmd} ${url}`, { stdio: "ignore" });
      } catch {
        // Ignore errors (e.g., no display)
      }
    }, 500);
  }

  import(serverPath).catch((err) => {
    console.error("Failed to start UI server:", err.message);
    process.exit(1);
  });
}
