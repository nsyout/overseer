// Overseer UI Server - Bundled with esbuild
import{serve as ne}from"@hono/node-server";import{Hono as J}from"hono";import{serveStatic as G}from"@hono/node-server/serve-static";import{Hono as re}from"hono";import{spawn as H}from"node:child_process";function d(e){return e.startsWith("task_")&&e.length===31}function O(e){return e.startsWith("lrn_")&&e.length===30}var f=class extends Error{constructor(t,n,o){super(t);this.exitCode=n;this.stderr=o;this.name="CliError"}},R=class extends Error{constructor(r="CLI command timeout (30s)"){super(r),this.name="CliTimeoutError"}};var M=3e4,F=process.env.OVERSEER_CLI_PATH??"os",z=process.env.OVERSEER_CLI_CWD??process.cwd();async function m(e){return new Promise((r,t)=>{let n=H(F,[...e,"--json"],{cwd:z,stdio:["ignore","pipe","pipe"]}),o=setTimeout(()=>{n.kill("SIGTERM"),t(new R)},M),u="",p="";n.stdout.on("data",l=>{u+=l.toString()}),n.stderr.on("data",l=>{p+=l.toString()}),n.on("error",l=>{clearTimeout(o),t(new f(`Failed to spawn os: ${l.message}`,-1,""))}),n.on("close",l=>{if(clearTimeout(o),l!==0){let c=p.trim()||`os exited with code ${l}`;t(new f(c,l??-1,p));return}try{let c=JSON.parse(u);r(c)}catch(c){t(new f(`Invalid JSON from os: ${c instanceof Error?c.message:String(c)}`,0,u))}})})}import{Result as s,TaggedError as K}from"better-result";var a=class extends K("DecodeError")(){};function T(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}function i(e){return typeof e=="string"}function D(e){return typeof e=="boolean"}function Q(e){return typeof e=="number"}function _(e){return Q(e)&&e>=1&&e<=5&&Number.isInteger(e)}function X(e){return e===0||e===1||e===2}function Y(e){if(!T(e))return s.err(new a({message:"Learning must be object"}));let{id:r,taskId:t,content:n,sourceTaskId:o,createdAt:u}=e;return!i(r)||!O(r)?s.err(new a({message:`Invalid learning id: ${r}`})):!i(t)||!d(t)?s.err(new a({message:`Invalid learning taskId: ${t}`})):i(n)?o!==null&&(!i(o)||!d(o))?s.err(new a({message:`Invalid learning sourceTaskId: ${o}`})):i(u)?s.ok({id:r,taskId:t,content:n,sourceTaskId:o,createdAt:u}):s.err(new a({message:"Learning createdAt must be string"})):s.err(new a({message:"Learning content must be string"}))}function I(e){if(!Array.isArray(e))return s.err(new a({message:"Learnings must be array"}));let r=[];for(let t=0;t<e.length;t++){let n=Y(e[t]);if(n.isErr())return s.err(new a({message:n.error.message,path:`learnings[${t}]`}));r.push(n.value)}return s.ok(r)}function y(e){if(!T(e))return s.err(new a({message:"Task must be object"}));let{id:r,parentId:t,description:n,priority:o,completed:u,completedAt:p,startedAt:l,createdAt:c,updatedAt:S,result:E,commitSha:A,depth:L,blockedBy:j,blocks:q,bookmark:h,startCommit:b,effectivelyBlocked:$}=e;if(!i(r)||!d(r))return s.err(new a({message:`Invalid task id: ${r}`}));if(t!==null&&(!i(t)||!d(t)))return s.err(new a({message:`Invalid task parentId: ${t}`}));if(!i(n))return s.err(new a({message:"Task description must be string"}));if(!_(o))return s.err(new a({message:`Invalid task priority: ${o}`}));if(!D(u))return s.err(new a({message:"Task completed must be boolean"}));if(p!==null&&!i(p))return s.err(new a({message:"Task completedAt must be string or null"}));if(l!==null&&!i(l))return s.err(new a({message:"Task startedAt must be string or null"}));if(!i(c))return s.err(new a({message:"Task createdAt must be string"}));if(!i(S))return s.err(new a({message:"Task updatedAt must be string"}));if(E!==null&&!i(E))return s.err(new a({message:"Task result must be string or null"}));if(A!==null&&!i(A))return s.err(new a({message:"Task commitSha must be string or null"}));if(!X(L))return s.err(new a({message:`Invalid task depth: ${L}`}));if(!D($))return s.err(new a({message:"Task effectivelyBlocked must be boolean"}));let x;if(j!==void 0){if(!Array.isArray(j))return s.err(new a({message:"Task blockedBy must be array"}));x=[];for(let g of j){if(!i(g)||!d(g))return s.err(new a({message:`Invalid blocker id: ${g}`}));x.push(g)}}let C;if(q!==void 0){if(!Array.isArray(q))return s.err(new a({message:"Task blocks must be array"}));C=[];for(let g of q){if(!i(g)||!d(g))return s.err(new a({message:`Invalid blocks id: ${g}`}));C.push(g)}}if(h!==void 0&&!i(h))return s.err(new a({message:"Task bookmark must be string"}));if(b!==void 0&&!i(b))return s.err(new a({message:"Task startCommit must be string"}));let w={id:r,parentId:t,description:n,priority:o,completed:u,completedAt:p,startedAt:l,createdAt:c,updatedAt:S,result:E,commitSha:A,depth:L,effectivelyBlocked:$};return x&&(w.blockedBy=x),C&&(w.blocks=C),h!==void 0&&(w.bookmark=h),b!==void 0&&(w.startCommit=b),s.ok(w)}function P(e){if(!Array.isArray(e))return s.err(new a({message:"Tasks must be array"}));let r=[];for(let t=0;t<e.length;t++){let n=y(e[t]);if(n.isErr())return s.err(new a({message:n.error.message,path:`tasks[${t}]`}));r.push(n.value)}return s.ok(r)}function Z(e){if(!T(e))return s.err(new a({message:"TaskContext must be object"}));let{own:r,parent:t,milestone:n}=e;if(!i(r))return s.err(new a({message:"TaskContext.own must be string"}));if(t!==void 0&&!i(t))return s.err(new a({message:"TaskContext.parent must be string"}));if(n!==void 0&&!i(n))return s.err(new a({message:"TaskContext.milestone must be string"}));let o={own:r};return t!==void 0&&(o.parent=t),n!==void 0&&(o.milestone=n),s.ok(o)}function ee(e){if(!T(e))return s.err(new a({message:"InheritedLearnings must be object"}));let{own:r,parent:t,milestone:n}=e,o=I(r??[]);if(o.isErr())return s.err(new a({message:o.error.message,path:"learnings.own"}));let u=I(t??[]);if(u.isErr())return s.err(new a({message:u.error.message,path:"learnings.parent"}));let p=I(n??[]);return p.isErr()?s.err(new a({message:p.error.message,path:"learnings.milestone"})):s.ok({own:o.value,parent:u.value,milestone:p.value})}function v(e){if(!T(e))return s.err(new a({message:"TaskWithContext must be object"}));let r=y(e);if(r.isErr())return r;let{context:t,learnings:n}=e,o=Z(t);if(o.isErr())return s.err(new a({message:o.error.message,path:"context"}));let u=ee(n);return u.isErr()?s.err(new a({message:u.error.message,path:"learnings"})):s.ok({...r.value,context:o.value,learnings:u.value})}function B(e){return e===null?s.ok(null):v(e)}function U(e){if(!T(e))return s.err(new a({message:"UpdateTaskRequest must be object"}));let{description:r,context:t,priority:n}=e,o={};if(r!==void 0){if(!i(r))return s.err(new a({message:"description must be string"}));o.description=r}if(t!==void 0){if(!i(t))return s.err(new a({message:"context must be string"}));o.context=t}if(n!==void 0){if(!_(n))return s.err(new a({message:`Invalid priority: ${n}`}));o.priority=n}return s.ok(o)}function W(e){if(!T(e))return s.err(new a({message:"CompleteTaskRequest must be object"}));let{result:r,learnings:t}=e,n={};if(r!==void 0){if(!i(r))return s.err(new a({message:"result must be string"}));n.result=r}if(t!==void 0){if(!Array.isArray(t))return s.err(new a({message:"learnings must be array"}));for(let o=0;o<t.length;o++)if(!i(t[o]))return s.err(new a({message:`learnings[${o}] must be string`}));n.learnings=t}return s.ok(n)}function k(e,r){if(r instanceof f){let n=r.message.toLowerCase();return n.includes("not found")||n.includes("no task")?e.json({error:r.message},404):n.includes("invalid")||n.includes("validation")||n.includes("cycle")?e.json({error:r.message},400):n.includes("not a repository")||n.includes("dirty working copy")?e.json({error:r.message,code:"VCS_ERROR"},400):e.json({error:r.message},500)}let t=r instanceof Error?r.message:String(r);return e.json({error:t},500)}var N=new re().get("/",async e=>{let r=e.req.query("parentId"),t=e.req.query("ready"),n=e.req.query("completed"),o=["task","list"];if(r){if(!d(r))return e.json({error:`Invalid parentId: ${r}`},400);o.push("--parent",r)}t==="true"&&o.push("--ready"),n==="true"&&o.push("--completed");try{let u=P(await m(o)).unwrap("GET /api/tasks");return e.json(u)}catch(u){return k(e,u)}}).get("/next-ready",async e=>{let r=e.req.query("milestoneId"),t=["task","next-ready"];if(r){if(!d(r))return e.json({error:`Invalid milestoneId: ${r}`},400);t.push("--milestone",r)}try{let n=B(await m(t)).unwrap("GET /api/tasks/next-ready");return n===null?e.json(null,200):e.json(n)}catch(n){return k(e,n)}}).get("/:id",async e=>{let r=e.req.param("id");if(!d(r))return e.json({error:`Invalid task ID: ${r}`},400);try{let t=v(await m(["task","get",r])).unwrap("GET /api/tasks/:id");return e.json(t)}catch(t){return k(e,t)}}).put("/:id",async e=>{let r=e.req.param("id");if(!d(r))return e.json({error:`Invalid task ID: ${r}`},400);let t;try{t=U(await e.req.json()).unwrap("PUT /api/tasks/:id body")}catch{return e.json({error:"Invalid JSON body"},400)}let n=["task","update",r];if(t.description&&n.push("-d",t.description),t.context&&n.push("--context",t.context),t.priority&&n.push("--priority",String(t.priority)),n.length===3)return e.json({error:"No fields to update"},400);try{let o=y(await m(n)).unwrap("PUT /api/tasks/:id");return e.json(o)}catch(o){return k(e,o)}}).delete("/:id",async e=>{let r=e.req.param("id");if(!d(r))return e.json({error:`Invalid task ID: ${r}`},400);try{return await m(["task","delete",r]),e.json({deleted:!0})}catch(t){return k(e,t)}}).post("/:id/complete",async e=>{let r=e.req.param("id");if(!d(r))return e.json({error:`Invalid task ID: ${r}`},400);let t;try{let o=await e.req.text();o?t=W(JSON.parse(o)).unwrap("POST /api/tasks/:id/complete body"):t={}}catch{return e.json({error:"Invalid JSON body"},400)}let n=["task","complete",r];if(t.result&&n.push("--result",t.result),t.learnings)for(let o of t.learnings)n.push("--learning",o);try{let o=y(await m(n)).unwrap("POST /api/tasks/:id/complete");return e.json(o)}catch(o){return k(e,o)}}).post("/:id/reopen",async e=>{let r=e.req.param("id");if(!d(r))return e.json({error:`Invalid task ID: ${r}`},400);try{let t=y(await m(["task","reopen",r])).unwrap("POST /api/tasks/:id/reopen");return e.json(t)}catch(t){return k(e,t)}}).get("/:taskId/learnings",async e=>{let r=e.req.param("taskId");if(!d(r))return e.json({error:`Invalid task ID: ${r}`},400);try{let t=I(await m(["learning","list",r])).unwrap("GET /api/tasks/:taskId/learnings");return e.json(t)}catch(t){return k(e,t)}});var te=new J().get("/health",e=>e.json({status:"ok"})).route("/api/tasks",N).all("/api/*",e=>e.json({error:"Not found"},404));function V(e){let r=e??process.env.OVERSEER_UI_STATIC_ROOT??"./static";return new J().route("/",te).use("/*",G({root:r})).get("/*",G({root:r,path:"index.html"}))}var se=process.env.PORT===void 0?6969:Number.parseInt(process.env.PORT,10)||6969,oe=process.env.OVERSEER_UI_STATIC_ROOT??"./dist",ae=V(oe);ne({fetch:ae.fetch,port:se},e=>{console.log(`Overseer UI: http://localhost:${e.port}`)});
//# sourceMappingURL=server.js.map
