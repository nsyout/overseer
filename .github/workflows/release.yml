name: Release Binaries

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  checks: read

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Normalize and validate tag version
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME}"
          VERSION="${VERSION#v}"

          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid semver: $VERSION"
            exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  preflight:
    needs: [validate]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          ref: ${{ github.ref }}

      - name: Verify latest main checks are green
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          TAG_VERSION: ${{ needs.validate.outputs.version }}
        run: |
          set -euo pipefail

          tag_sha="$(git rev-parse HEAD)"
          main_sha="$(gh api "repos/${REPO}/commits/main" --jq '.sha')"
          echo "Tag SHA:  ${tag_sha}"
          echo "Main SHA: ${main_sha}"

          if [[ "$tag_sha" != "$main_sha" ]]; then
            echo "Refusing release: tag does not point to current main HEAD."
            exit 1
          fi

          cargo_version="$(sed -n 's/^version = "\([0-9][0-9.]*\)"$/\1/p' overseer/Cargo.toml | head -n1)"
          host_version="$(jq -r '.version' host/package.json)"
          ui_version="$(jq -r '.version' ui/package.json)"

          echo "Cargo version: $cargo_version"
          echo "Host version:  $host_version"
          echo "UI version:    $ui_version"

          if [[ "$cargo_version" != "$TAG_VERSION" || "$host_version" != "$TAG_VERSION" || "$ui_version" != "$TAG_VERSION" ]]; then
            echo "Version mismatch: tag v${TAG_VERSION} does not match project versions."
            exit 1
          fi

          check_runs_json="$(gh api "repos/${REPO}/commits/${main_sha}/check-runs")"

          required_checks=(
            "Rust checks"
            "Host checks"
            "UI checks"
            "Secret scan (gitleaks)"
            "Rust dependency audit"
            "Node dependency audit (host)"
            "Node dependency audit (ui)"
            "Analyze (javascript-typescript)"
            "Analyze (rust)"
          )

          failed=0
          for name in "${required_checks[@]}"; do
            status="$(jq -r --arg name "$name" 'first(.check_runs[] | select(.name == $name) | .status) // "missing"' <<< "$check_runs_json")"
            conclusion="$(jq -r --arg name "$name" 'first(.check_runs[] | select(.name == $name) | .conclusion) // "missing"' <<< "$check_runs_json")"

            if [[ "$status" == "missing" ]]; then
              echo "Missing required check run on main: $name"
              failed=1
              continue
            fi

            echo "$name -> status=$status conclusion=$conclusion"

            if [[ "$status" != "completed" || "$conclusion" != "success" ]]; then
              echo "Required check is not green on main: $name"
              failed=1
            fi
          done

          if [[ "$failed" -ne 0 ]]; then
            echo "Preflight failed: main branch checks are not fully green."
            exit 1
          fi

  build:
    needs: [validate, preflight]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            name: darwin-arm64
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            name: linux-x64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6.0.2

      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Build os binary
        working-directory: overseer
        env:
          RUSTFLAGS: "-C strip=symbols"
        run: cargo build --release --target ${{ matrix.target }}

      - name: Archive artifact
        run: |
          mkdir -p release
          cp overseer/target/${{ matrix.target }}/release/os release/os
          chmod +x release/os
          tar -czf release/os-${{ matrix.name }}.tar.gz -C release os

      - name: Upload artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: os-${{ matrix.name }}
          path: release/os-${{ matrix.name }}.tar.gz

  release:
    needs: [validate, preflight, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.2

      - uses: actions/download-artifact@v7.0.0
        with:
          path: artifacts

      - name: Gather artifacts
        run: |
          mkdir -p release
          find artifacts -name '*.tar.gz' -exec cp {} release/ \;

      - name: Generate checksums
        run: |
          cd release
          sha256sum *.tar.gz > checksums-sha256.txt
          cat checksums-sha256.txt

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "v${{ needs.validate.outputs.version }}" release/* --generate-notes
